{"version":3,"file":"coroutines.iife.js","sources":["../coroutines.ts"],"sourcesContent":["\n/**\n * A container for running coroutines.\n * \n * @remarks this might be renamed \"Timeline\" in the future  \n * \n */\nexport class Coroutines {\n    private coroutines : Iterator<any>[] = []\n    /**\n     * For debugging\n     */\n    public readonly name : string;\n    \n    constructor(name = generateNewName()) {\n        this.name = name;\n    }\n\n    /**\n     * Schedules a coroutine for evaluation.\n     * \n     * Future calls to [[tick]] will run `coro` up to its next `yield` until it is completed.\n     * \n     * As a convenience if `coro` is a generator function and not a generator, it will be evaluated to produce a generator.\n     * \n     * ```js\n     * function* coroutineFunction() { ... }\n     * let coro = new Coroutines()\n     * coro.start(coroutineFunction()) // this works\n     * coro.start(coroutineFunction)   // so does this\n     * ```\n     * \n     * @param coro coroutine to start\n     */\n    public start(coro:Iterator<any>|(()=>Iterator<any>)) {\n        let c = \"next\" in coro ? coro : coro();\n        this.coroutines.push(c)\n        return c\n    }\n\n    /**\n     * Stops a single coroutine\n     * \n     * @param coro coroutine to stop\n     */\n    public stop(coro: Iterator<any>) {\n        this.coroutines.splice(this.coroutines.indexOf(coro), 1)\n    }\n\n    /**\n     * Discards all scheduled coroutines\n     */\n    public stopAll() {\n        this.coroutines = []\n    }\n\n    /**\n     * Runs all scheduled coroutines once.\n     * \n     * Each coroutine added with [[start]] will run up to its next `yield` statement. Finished coroutines are removed\n     * from the collection.\n     */\n    public tick() {\n        let toRemove = []\n        for(const coro of this.coroutines) {\n            let result = coro.next()\n            if(result.done) {\n                toRemove.push(coro)\n            }\n      }\n      for (const x of toRemove) {\n        this.coroutines.splice(this.coroutines.indexOf(x), 1)\n      }\n    }\n}\n/**\n * @hidden until typedoc can check \"only exported\" by default\n */\nlet generateNewName = () => Math.random().toString(36).replace(\"0.\", \"Coroutines.\")\n\nif(typeof window === \"undefined\") {\n    global[\"performance\"] = require(\"perf_hooks\").performance;\n}\n\n/**\n * @hidden until typedoc can check \"only exported\" by default\n */\nlet _clock = () => performance.now() / 1000\n\n/**\n * Sets a new clock function.\n * \n * The clock function returns the elapsed application time in seconds. It is called by some coroutines to measure the\n * passage of time. defaults to `performance.now() / 1000`\n *\n * @param f New clock function\n */\nexport function setClock(f: () => number) {\n    _clock = f\n}\n\n/**\n * Wait for a number of seconds.\n * \n * @category Coroutine\n * \n * @param seconds How many seconds to wait\n * @param clock A function that returns the elapsed application time in seconds, defaults to the function assigned by [[setClock]]\n * @see [[setClock]]\n */\nexport function* wait(seconds: number, clock = _clock) {\n    let startTime = clock()\n    while (clock() - startTime < seconds) {\n        yield;\n    }\n}\n\n/**\n * Wait for a number of frames.\n * \n * @category Coroutine\n * \n * @param n How many frames to wait\n */\nexport function* waitFrames(n: number) {\n    while (n-- > 0) {\n        yield;\n    }\n}\n\n/**\n * Wait until a function `f` returns true.\n * \n * @category Coroutine\n * \n * @param f A function to execute every frame. When `f` returns truthy this coroutine completes.\n */\nexport function* waitUntil(f: () => boolean) {\n    while(!f()) {\n        yield;\n    }\n}\n\n/**\n * Wait while a function `f` returns true.\n * \n * @category Coroutine\n * \n * @param f A function to execute every frame. When `f` returns falsey this coroutine completes.\n */\nexport function* waitWhile(f: () => boolean) {\n    while(f()) {\n        yield;\n    }\n}\n\n/**\n * Animate a parameter.\n * \n * @category Coroutine\n * \n * \n * @param obj The object to mutate\n * @param prop The property on `obj` to mutate\n * @param to The final value of `obj.prop`\n * @param map A function to shape the animation curve. Given a value between 0 and 1 returns a value between 0 and 1. Defaults to the identity function (no shaping).\n * @param map.x A value between 0 and 1\n * @param clock The clock function used to measure time. Defaults to the function set by [[setClock]]\n * @param interpolate Interpolating function. Given values `a` and `b` returns their interpolated value at `t`, a number between 0 and 1. Defaults to linear interpolation.\n * @param interpolate.a The starting value\n * @param interpolate.b The final value\n * @param interpolate.t The interpolation value, a number between 0 and 1\n * @todo needs way to specify animation speed or time\n * @see [[setClock]]\n */\nexport function* animate(obj: any, prop: string, to:any, { clock = _clock, map = (x:number) => x, interpolate = (a:any, b:any, t:number) => b * t + a * (1 - t) } ) {\n    let from = obj[prop];\n    let t = 0\n    let lastTime = clock()\n    while(t < 1) {\n        let nowTime = clock()\n        let delta = nowTime - lastTime\n        lastTime = nowTime\n        obj[prop] = interpolate(from, to, map(t))\n        t += delta\n        yield;\n    }\n}\n\n/**\n * @hidden\n */\nlet advance = (c:Iterator<any>) => c.next()\n\n/**\n * @hidden\n */\nlet initialize = (c:(Iterator<any>|(()=>Iterator<any>))) => typeof c === \"function\" ? c() : c\n\n/**\n * @category Combinator\n * @param coros Coroutines\n */\nexport function* waitLast(coros:Iterator<any>[]) {\n    let results = coros.map(advance)\n    while(results.filter(r => r.done).length !== coros.length) {\n      yield;\n      for (var i = 0; i < coros.length; i++) {\n        let coro = coros[i]\n        let res = results[i]\n        if(!res.done) {\n          results[i] = advance(coro)\n        }\n      }\n    }\n  }\n  \n  /**\n   * @category Combinator\n   * @param coros Coroutines\n   */\n  export function* waitFirst(coros:Iterator<any>[]) {\n    let results = coros.map(advance)\n    while(results.filter(r => r.done).length === 0) {\n      yield;\n      for (var i = 0; i < coros.length; i++) {\n        let coro = coros[i]\n        let res = results[i]\n        if(!res.done) {\n          results[i] = advance(coro) \n        }\n      }\n    }\n  }\n\n  /**\n   * @category Combinator\n   * @param coros Coroutines\n   */\nexport function* sequence(coros:(Iterator<any>|(()=>Iterator<any>))[]) {\n    if(coros.length == 0) return;\n    for (let i = 0; i < coros.length; i++) {\n        const gen = initialize(coros[i]);\n        let res = gen.next()\n        yield;\n        while(!res.done) {\n            res = gen.next()\n            yield;\n        }\n    }\n  }"],"names":[],"mappings":"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"}